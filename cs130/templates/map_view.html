{% extends "application.html" %}

{% load static %}

{% block title %}IP Based Location{% endblock %}

{% block javascript %}

  <script type="text/javascript"
      src="http://maps.google.com/maps/api/js?sensor=false">
  </script>
  <script type="text/javascript">
  
	var json_list = {{json_list|safe}};
	var map;
	var markerArray = [];
  
    function initialize(latitude, longitude, countryName)
	{
		var latlng = new google.maps.LatLng({{location_info.latitude}}, longitude);

		var numMarkers = 10;
		var myOptions =
		{
			zoom: 10,
			center: latlng,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		
		map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

		var geocoder = new google.maps.Geocoder();
		 
		for(var i in json_list)
		{
			 var position = new google.maps.LatLng();
			 geocoder.geocode( {'address':json_list[i].location},function(results,status) {
                    if (status == google.maps.GeocoderStatus.OK) {
						position = results[0].geometry.location;
					}
				    if (status != google.maps.GeocoderStatus.OK) {
						//alert(status);
						}
						
			});
			
			create_marker(position,json_list[i].title);
			
			display_marker(markerArray[i],'<div class="item"><div class="item-image"><img src="' + json_list[i].galleryURL + '"/></div><div class="item-info"><h2><a href="' + json_list[i].viewItemURL + '">' + json_list[i].title + '</a><br/></h2>Location: ' + json_list.location + '<br/><br/><b>Current Price:' +  json_list[i].sellingStatus.currentPrice.value + json_list[i].sellingStatus.currentPrice.currencyId + '<br/>Time Left: ' + json_list[i].sellingStatus.timeLeft + '</div></div>');
			
		}

	 }
	 
	 function create_marker(location, city)
	 {
		marker = new google.maps.Marker({
                        position: location,
			map: map,
			title: city
			});
			
		markerArray.push(marker);
	 }

     function display_marker(marker, title)
     {
		var contentString = title;
		var infoWindow = new google.maps.InfoWindow({
            content: contentString
        });
 
        google.maps.event.addListener(marker, 'click', function(){
            infoWindow.open(map, marker)
        });
     }
	 

  </script>

{% endblock %}

{% block body-tag %}
<body onload="initialize({{location_info.latitude}}, {{location_info.longitude}}, '{{location_info.countryName}}' )">
{% endblock %}


{% block content %}
<div class="main-search-box">
  <img src="{% get_static_prefix %}logo_large.png" class="logo-large" />
  <div class="search-box">
    <form action="/search" method="get" class="search-form">
      {{ search_form }}
      <input type="submit" value="Search" class="search-button">
    </form>
  </div>
</div>

<div id="results-wrapper" class="rounded-all">
  <div id="map-canvas"></div>

  My IP: {{location_info.ipAddress}}

  Country: {{location_info.countryName}}

  Region: {{location_info.regionName}}

  Zip Code: {{location_info.zipCode}}

  Latitude: {{location_info.latitude}}

  Longitude: {{location_info.longitude}}

  Time Zone: {{location_info.timeZone}}
</div>
{% endblock %}
